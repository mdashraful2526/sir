<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dumuria Govt. Technical School - Result System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="text-3xl text-blue-600 font-bold mb-4">Loading...</div>
            <div id="loadingStatus" class="text-gray-600">Initializing Firebase...</div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h1 class="text-4xl font-bold text-center text-blue-900 mb-2">
                üéì Dumuria Government Technical School & College
            </h1>
            <p class="text-center text-gray-600">Student Result Management System</p>
        </div>

        <div class="flex justify-end mb-6">
            <button onclick="showLogin()" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                üë§ Admin Login
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üîç Search Student Result</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="searchName" placeholder="Student Name" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                <input type="text" id="searchRoll" placeholder="Roll Number" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                <select id="searchClass" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="">Select Class</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <select id="searchBranch" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="">Select Branch</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                </select>
            </div>
            <button onclick="searchStudent()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                üîç Search Result
            </button>

            <div id="searchResult" class="hidden mt-6 p-4 bg-green-50 border-2 border-green-500 rounded-lg">
                <h3 class="text-xl font-bold text-green-800 mb-4">‚úÖ Result Found!</h3>
                <div id="searchResultContent" class="bg-white p-4 rounded-lg"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã All Students</h2>
            <div id="allStudentsList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">üîê Admin Login</h2>
            <input type="text" id="loginUsername" placeholder="Username" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 mb-4 focus:border-blue-500 focus:outline-none">
            <input type="password" id="loginPassword" placeholder="Password" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 mb-6 focus:border-blue-500 focus:outline-none">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition mb-4">
                Login
            </button>
            <button onclick="showHome()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Back to Home
            </button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPage" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-900">üë®‚Äçüè´ Admin Panel</h1>
            <button onclick="handleLogout()" class="flex items-center gap-2 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
                üö™ Logout
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ûï Add New Student</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="text" id="newStudentName" placeholder="Student Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="number" id="newStudentRoll" placeholder="Roll" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newFatherName" placeholder="Father Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newMotherName" placeholder="Mother Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newPhone" placeholder="Phone Number" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <select id="newStudentClass" onchange="checkDepartment()" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                </select>
                <select id="newStudentBranch" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="A">Branch A</option>
                    <option value="B">Branch B</option>
                </select>
                <select id="newStudentDepartment" class="hidden border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="">Select Department</option>
                    <option value="Civil">Civil</option>
                    <option value="Computer">Computer</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Mechanical">Mechanical</option>
                </select>
            </div>
            <button onclick="addStudent()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">
                ‚ûï Add Student
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìù Enter Marks by Subject</h2>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Select Class:</label>
                <div class="flex flex-wrap gap-2">
                    <button onclick="selectClass('6')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="6">Class 6</button>
                    <button onclick="selectClass('7')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="7">Class 7</button>
                    <button onclick="selectClass('8')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="8">Class 8</button>
                    <button onclick="selectClass('9')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="9">Class 9</button>
                    <button onclick="selectClass('10')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="10">Class 10</button>
                </div>
            </div>

            <div id="subjectSelection" class="hidden mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Select Subject:</label>
                <div id="subjectButtons" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>

            <div id="markEntryTable" class="hidden overflow-x-auto"></div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-900">Student Result</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCy9gJJsEfgoT1CLAtaNiaykrrPSTC9q1g",
            authDomain: "sctop-d22bc.firebaseapp.com",
            projectId: "sctop-d22bc",
            storageBucket: "sctop-d22bc.firebasestorage.app",
            messagingSenderId: "733891150436",
            appId: "1:733891150436:web:8ca3a0057030914d8f9571"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let students = [];
        let isAdmin = false;
        let selectedClass = '';
        let selectedSubject = '';

        // Subjects Configuration
        const subjects = {
            '6': ['Bangla', 'English', 'Math', 'Science', 'Social Science', 'Religion'],
            '7': ['Bangla', 'English', 'Math', 'Science', 'Social Science', 'Religion'],
            '8': ['Bangla', 'English', 'Math', 'Science', 'Social Science', 'Religion'],
            '9-Civil': ['Bangla', 'English', 'Math', 'Science', 'Trade 1', 'Trade 2'],
            '9-Computer': ['Bangla', 'English', 'Math', 'Science', 'Computer 1', 'Computer 2'],
            '9-Electrical': ['Bangla', 'English', 'Math', 'Science', 'Electrical 1', 'Electrical 2'],
            '9-Mechanical': ['Bangla', 'English', 'Math', 'Science', 'Mechanical 1', 'Mechanical 2'],
            '10-Civil': ['Bangla', 'English', 'Math', 'Science', 'Trade 1', 'Trade 2'],
            '10-Computer': ['Bangla', 'English', 'Math', 'Science', 'Computer 1', 'Computer 2'],
            '10-Electrical': ['Bangla', 'English', 'Math', 'Science', 'Electrical 1', 'Electrical 2'],
            '10-Mechanical': ['Bangla', 'English', 'Math', 'Science', 'Mechanical 1', 'Mechanical 2']
        };

        const departments = ['Civil', 'Computer', 'Electrical', 'Mechanical'];

        // Demo Data
        const demoData = [
            { name: "‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶ï‡¶∞‡¶ø‡¶Æ", motherName: "‡¶∏‡¶æ‡¶≤‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01711111111", class: "6", branch: "A", department: "" },
            { name: "‡¶´‡¶æ‡¶§‡¶ø‡¶Æ‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", roll: 2, fatherName: "‡¶Æ‡ßã‡¶π‡¶æ‡¶Æ‡ßç‡¶Æ‡¶¶ ‡¶Ü‡¶≤‡ßÄ", motherName: "‡¶∞‡ßã‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01722222222", class: "6", branch: "A", department: "" },
            { name: "‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 1, fatherName: "‡¶π‡¶æ‡¶∏‡¶æ‡¶® ‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ", motherName: "‡¶Ü‡¶Ø‡¶º‡ßá‡¶∂‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", phone: "01733333333", class: "6", branch: "B", department: "" },
            { name: "‡¶®‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", roll: 2, fatherName: "‡¶Ü‡¶¨‡ßÅ‡¶≤ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∞‡ßÅ‡¶Æ‡¶æ‡¶®‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01744444444", class: "6", branch: "B", department: "" },
            
            { name: "‡¶∏‡¶æ‡¶ï‡¶ø‡¶¨ ‡¶Ü‡¶≤ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 1, fatherName: "‡¶®‡¶ú‡¶∞‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∂‡¶æ‡¶™‡¶≤‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01755555555", class: "7", branch: "A", department: "" },
            { name: "‡¶§‡¶æ‡¶∏‡¶®‡¶ø‡¶Æ ‡¶ú‡¶æ‡¶π‡¶æ‡¶®", roll: 2, fatherName: "‡¶ú‡¶π‡¶ø‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®", motherName: "‡¶™‡¶æ‡¶∞‡¶≠‡ßÄ‡¶® ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01766666666", class: "7", branch: "A", department: "" },
            { name: "‡¶∞‡¶æ‡¶´‡¶ø ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶Ü‡¶®‡ßã‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", motherName: "‡¶∂‡¶æ‡¶π‡¶®‡¶æ‡¶ú ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01777777777", class: "7", branch: "B", department: "" },
            
            { name: "‡¶∏‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶´‡¶∞‡¶ø‡¶®", roll: 1, fatherName: "‡¶Æ‡¶§‡¶ø‡¶â‡¶∞ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶®", motherName: "‡¶∏‡ßÅ‡¶Æ‡¶æ‡¶á‡¶Ø‡¶º‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", phone: "01788888888", class: "8", branch: "A", department: "" },
            { name: "‡¶§‡¶æ‡¶®‡¶≠‡ßÄ‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", roll: 2, fatherName: "‡¶∂‡¶æ‡¶Æ‡¶∏‡ßÅ‡¶≤ ‡¶π‡¶ï", motherName: "‡¶®‡¶æ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01799999999", class: "8", branch: "A", department: "" },
            
            { name: "‡¶§‡¶æ‡¶®‡¶≠‡ßÄ‡¶∞ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶ú‡¶π‡¶ø‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®", motherName: "‡¶™‡¶æ‡¶∞‡¶≠‡ßÄ‡¶® ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000001", class: "9", branch: "A", department: "Civil" },
            { name: "‡¶Æ‡ßá‡¶π‡ßá‡¶¶‡ßÄ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 2, fatherName: "‡¶Ü‡¶≤‡¶Æ‡¶ó‡ßÄ‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", motherName: "‡¶∞‡ßá‡¶π‡¶æ‡¶®‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000002", class: "9", branch: "A", department: "Civil" },
            { name: "‡¶®‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", roll: 1, fatherName: "‡¶Ü‡¶¨‡ßÅ‡¶≤ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∞‡ßÅ‡¶Æ‡¶æ‡¶®‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000003", class: "9", branch: "A", department: "Computer" },
            { name: "‡¶∏‡¶æ‡¶¨‡¶ø‡¶π‡¶æ ‡¶ñ‡¶æ‡¶®", roll: 2, fatherName: "‡¶ï‡¶æ‡¶Æ‡¶æ‡¶≤ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®", motherName: "‡¶´‡¶∞‡¶ø‡¶¶‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000004", class: "9", branch: "B", department: "Computer" },
            { name: "‡¶Ü‡¶∞‡¶ø‡¶´ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶®", roll: 1, fatherName: "‡¶π‡¶æ‡¶¨‡¶ø‡¶¨‡ßÅ‡¶∞ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶®", motherName: "‡¶®‡¶æ‡¶∏‡¶∞‡¶ø‡¶® ‡¶∏‡ßÅ‡¶≤‡¶§‡¶æ‡¶®‡¶æ", phone: "01700000005", class: "9", branch: "A", department: "Electrical" },
            { name: "‡¶§‡ßå‡¶π‡¶ø‡¶¶ ‡¶Ü‡¶≤‡¶Æ", roll: 1, fatherName: "‡¶∏‡¶æ‡¶á‡¶´‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", motherName: "‡¶ú‡ßá‡¶∏‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000006", class: "9", branch: "B", department: "Mechanical" },
            
            { name: "‡¶∞‡¶æ‡¶ï‡¶ø‡¶¨ ‡¶π‡ßã‡¶∏‡ßá‡¶®", roll: 1, fatherName: "‡¶∂‡¶æ‡¶Æ‡¶∏‡ßÅ‡¶≤ ‡¶π‡¶ï", motherName: "‡¶®‡¶æ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000007", class: "10", branch: "A", department: "Civil" },
            { name: "‡¶∏‡ßÅ‡¶Æ‡¶æ‡¶á‡¶Ø‡¶º‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", roll: 1, fatherName: "‡¶Æ‡¶®‡¶ø‡¶∞‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∞‡ßã‡¶ú‡¶ø‡¶®‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000008", class: "10", branch: "B", department: "Computer" },
            { name: "‡¶ú‡ßÅ‡¶®‡¶æ‡¶Ø‡¶º‡ßá‡¶¶ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶Æ‡¶æ‡¶≤‡ßá‡¶ï", motherName: "‡¶∏‡ßá‡¶≤‡¶ø‡¶®‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000009", class: "10", branch: "A", department: "Electrical" },
            { name: "‡¶´‡¶æ‡¶π‡¶ø‡¶Æ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 1, fatherName: "‡¶∞‡¶´‡¶ø‡¶ï‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", motherName: "‡¶®‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000010", class: "10", branch: "B", department: "Mechanical" }
        ];

        // Update Loading Status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = message;
        }

        // Initialize and Load Data from Firestore
        async function init() {
            try {
                updateLoadingStatus('Checking Firebase connection...');
                
                // Check if data exists in Firestore
                const classesSnapshot = await db.collection('students').get();
                
                if (classesSnapshot.empty) {
                    updateLoadingStatus('No data found. Creating demo data...');
                    await createDemoDataInFirestore();
                } else {
                    updateLoadingStatus('Loading data from Firebase...');
                }
                
                // Load all students
                await loadAllStudents();
                
                updateLoadingStatus('Complete!');
                showHome();
            } catch (error) {
                console.error('Firebase Error:', error);
                updateLoadingStatus('Error: ' + error.message);
                alert('Firebase connection failed. Please check console for details.');
            }
        }

        // Create Demo Data in Firestore
        async function createDemoDataInFirestore() {
            const batch = db.batch();
            let count = 0;

            for (const student of demoData) {
                const subjectKey = student.class >= '9' ? `${student.class}-${student.department}` : student.class;
                const marks = {};
                
                subjects[subjectKey]?.forEach(subject => {
                    marks[subject] = Math.floor(Math.random() * 40) + 60;
                });

                const collectionPath = student.class >= '9' 
                    ? `students/class_${student.class}/${student.department.toLowerCase()}`
                    : `students/class_${student.class}/branch_${student.branch}`;

                const docRef = db.collection(collectionPath).doc();
                
                batch.set(docRef, {
                    id: docRef.id,
                    name: student.name,
                    roll: student.roll,
                    fatherName: student.fatherName,
                    motherName: student.motherName,
                    phone: student.phone,
                    class: student.class,
                    branch: student.branch,
                    department: student.department,
                    marks: marks,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                count++;
                updateLoadingStatus(`Creating demo data... (${count}/${demoData.length})`);
            }

            await batch.commit();
            updateLoadingStatus('Demo data created successfully!');
        }

        // Load All Students from Firestore
        async function loadAllStudents() {
            students = [];
            
            for (let cls = 6; cls <= 10; cls++) {
                if (cls >= 9) {
                    // Load by department for class 9-10
                    for (const dept of departments) {
                        const snapshot = await db.collection(`students/class_${cls}/${dept.toLowerCase()}`).get();
                        snapshot.forEach(doc => {
                            students.push({ ...doc.data(), firestoreId: doc.id });
                        });
                    }
                } else {
                    // Load by branch for class 6-8
                    for (const branch of ['A', 'B']) {
                        const snapshot = await db.collection(`students/class_${cls}/branch_${branch}`).get();
                        snapshot.forEach(doc => {
                            students.push({ ...doc.data(), firestoreId: doc.id });
                        });
                    }
                }
            }
        }

        // Page Navigation
        function showPage(page) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (page === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                renderAllStudents();
            } else if (page === 'login') {
                document.getElementById('loginPage').classList.remove('hidden');
            } else if (page === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
            }
        }

        function showHome() { showPage('home'); }
        function showLogin() { showPage('login'); }
        function showAdmin() { showPage('admin'); }

        // Login
        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === 'admin' && password === 'admin') {
                isAdmin = true;
                showAdmin();
            } else {
                alert('Invalid credentials!');
            }
        }

        function handleLogout() {
            isAdmin = false;
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showHome();
        }

        // Search Student
        function searchStudent() {
            const name = document.getElementById('searchName').value.toLowerCase();
            const roll = document.getElementById('searchRoll').value;
            const cls = document.getElementById('searchClass').value;
            const branch = document.getElementById('searchBranch').value;

            const result = students.find(s => 
                (name && s.name.toLowerCase().includes(name)) ||
                (roll && s.roll.toString() === roll) ||
                (cls && branch && s.class === cls && s.branch === branch)
            );

            const resultDiv = document.getElementById('searchResult');
            const contentDiv = document.getElementById('searchResultContent');

            if (result) {
                resultDiv.classList.remove('hidden');
                contentDiv.innerHTML = `
                    <p><strong>Name:</strong> ${result.name}</p>
                    <p><strong>Roll:</strong> ${result.roll}</p>
                    <p><strong>Class:</strong> ${result.class} | <strong>Branch:</strong> ${result.branch}</p>
                    ${result.department ? `<p><strong>Department:</strong> ${result.department}</p>` : ''}
                    <div class="mt-4">
                        <button onclick='showStudentDetail(${JSON.stringify(result)})' class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mr-2">
                            View Full Result
                        </button>
                        <button onclick='downloadPDF(${JSON.stringify(result)})' class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            üì• Download PDF
                        </button>
                    </div>
                `;
            } else {
                resultDiv.classList.remove('hidden');
                contentDiv.innerHTML = '<p class="text-red-600 font-semibold">‚ùå No student found!</p>';
            }
        }

        // Render All Students
        function renderAllStudents() {
            const container = document.getElementById('allStudentsList');
            container.innerHTML = students.slice(0, 20).map(student => `
                <div onclick='showStudentDetail(${JSON.stringify(student)})' class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-lg cursor-pointer transition">
                    <h3 class="font-bold text-lg text-blue-900">${student.name}</h3>
                    <p class="text-gray-600">Roll: ${student.roll}</p>
                    <p class="text-gray-600">Class: ${student.class} | Branch: ${student.branch}</p>
                    ${student.department ? `<p class="text-gray-600 text-sm">${student.department}</p>` : ''}
                </div>
            `).join('');
        }

        // Show Student Detail Modal
        function showStudentDetail(student) {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('modalContent');
            
            const total = Object.values(student.marks).reduce((sum, mark) => sum + parseInt(mark || 0), 0);
            
            content.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-lg"><strong>Name:</strong> ${student.name}</p>
                    <p><strong>Father:</strong> ${student.fatherName} | <strong>Mother:</strong> ${student.motherName}</p>
                    <p><strong>Phone:</strong> ${student.phone}</p>
                    <p><strong>Roll:</strong> ${student.roll} | <strong>Class:</strong> ${student.class} | <strong>Branch:</strong> ${student.branch}</p>
                    ${student.department ? `<p><strong>Department:</strong> ${student.department}</p>` : ''}
                </div>

                <table class="w-full border-collapse mb-4">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="border border-gray-300 p-3">Subject</th>
                            <th class="border border-gray-300 p-3">Marks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(student.marks).map(([subject, mark]) => `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-3">${subject}</td>
                                <td class="border border-gray-300 p-3 text-center font-semibold">${mark}</td>
                            </tr>
                        `).join('')}
                        <tr class="bg-green-100 font-bold">
                            <td class="border border-gray-300 p-3">TOTAL</td>
                            <td class="border border-gray-300 p-3 text-center">${total}</td>
                        </tr>
                    </tbody>
                </table>

                <button onclick='downloadPDF(${JSON.stringify(student)})' class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                    üì• Download Result PDF
                </button>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('studentModal').classList.add('hidden');
        }

        // Download PDF
        function downloadPDF(student) {
            const subjectKey = student.class >= '9' ? `${student.class}-${student.department}` : student.class;
            const studentSubjects = subjects[subjectKey] || [];
            const total = Object.values(student.marks).reduce((sum, mark) => sum + parseInt(mark || 0), 0);
            
            const pdfHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4 landscape; margin: 20mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { color: #1e40af; margin: 5px 0; font-size: 28px; }
        .header h2 { color: #4b5563; margin: 5px 0; font-size: 18px; }
        .info { display: flex; justify-content: space-between; margin: 20px 0; padding: 15px; background: #f3f4f6; border-radius: 8px; }
        .info-item { margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 2px solid #2563eb; padding: 12px; text-align: center; }
        th { background: #2563eb; color: white; font-size: 16px; }
        tr:nth-child(even) { background: #eff6ff; }
        .total { font-weight: bold; background: #dbeafe !important; font-size: 18px; }
        .footer { margin-top: 30px; text-align: center; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Dumuria Government Technical School & College</h1>
        <h2>Academic Result Sheet</h2>
    </div>
    
    <div class="info">
        <div>
            <div class="info-item"><strong>Student Name:</strong> ${student.name}</div>
            <div class="info-item"><strong>Father Name:</strong> ${student.fatherName}</div>
            <div class="info-item"><strong>Mother Name:</strong> ${student.motherName}</div>
        </div>
        <div>
            <div class="info-item"><strong>Roll Number:</strong> ${student.roll}</div>
            <div class="info-item"><strong>Class:</strong> ${student.class} | <strong>Branch:</strong> ${student.branch}</div>
            ${student.department ? `<div class="info-item"><strong>Department:</strong> ${student.department}</div>` : ''}
            <div class="info-item"><strong>Phone:</strong> ${student.phone}</div>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Subject</th>
                <th>Marks Obtained</th>
                <th>Total Marks</th>
            </tr>
        </thead>
        <tbody>
            ${studentSubjects.map(subject => `
                <tr>
                    <td>${subject}</td>
                    <td>${student.marks[subject] || 0}</td>
                    <td>100</td>
                </tr>
            `).join('')}
            <tr class="total">
                <td>TOTAL</td>
                <td>${total}</td>
                <td>${studentSubjects.length * 100}</td>
            </tr>
        </tbody>
    </table>
    
    <div class="footer">
        <p>Generated on ${new Date().toLocaleDateString()}</p>
        <p>This is a computer-generated document</p>
    </div>
</body>
</html>`;

            const blob = new Blob([pdfHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Result_${student.name}_Class${student.class}${student.branch}.html`;
            a.click();
        }

        // Add Student
        function checkDepartment() {
            const cls = document.getElementById('newStudentClass').value;
            const deptSelect = document.getElementById('newStudentDepartment');
            
            if (cls === '9' || cls === '10') {
                deptSelect.classList.remove('hidden');
            } else {
                deptSelect.classList.add('hidden');
                deptSelect.value = '';
            }
        }

        async function addStudent() {
            const name = document.getElementById('newStudentName').value;
            const roll = document.getElementById('newStudentRoll').value;
            const fatherName = document.getElementById('newFatherName').value;
            const motherName = document.getElementById('newMotherName').value;
            const phone = document.getElementById('newPhone').value;
            const cls = document.getElementById('newStudentClass').value;
            const branch = document.getElementById('newStudentBranch').value;
            const department = document.getElementById('newStudentDepartment').value;

            if (!name || !roll || !fatherName || !motherName || !phone) {
                alert('Please fill all required fields!');
                return;
            }

            if ((cls === '9' || cls === '10') && !department) {
                alert('Please select department for Class 9/10!');
                return;
            }

            const subjectKey = cls >= '9' ? `${cls}-${department}` : cls;
            const marks = {};
            subjects[subjectKey]?.forEach(subject => {
                marks[subject] = 0;
            });

            const collectionPath = cls >= '9' 
                ? `students/class_${cls}/${department.toLowerCase()}`
                : `students/class_${cls}/branch_${branch}`;

            try {
                const docRef = await db.collection(collectionPath).add({
                    name: name,
                    roll: parseInt(roll),
                    fatherName: fatherName,
                    motherName: motherName,
                    phone: phone,
                    class: cls,
                    branch: branch,
                    department: department,
                    marks: marks,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Reload students
                await loadAllStudents();

                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentRoll').value = '';
                document.getElementById('newFatherName').value = '';
                document.getElementById('newMotherName').value = '';
                document.getElementById('newPhone').value = '';
                alert('Student added successfully!');
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }

        // Select Class for Mark Entry
        function selectClass(cls) {
            selectedClass = cls;
            selectedSubject = '';
            
            document.querySelectorAll('[data-class]').forEach(btn => {
                if (btn.getAttribute('data-class') === cls) {
                    btn.className = 'px-6 py-3 rounded-lg transition bg-blue-600 text-white';
                } else {
                    btn.className = 'px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });

            renderSubjects();
        }

        // Render Subjects
        function renderSubjects() {
            const container = document.getElementById('subjectButtons');
            const section = document.getElementById('subjectSelection');
            section.classList.remove('hidden');
            
            let subjectsList = [];
            
            if (selectedClass === '9' || selectedClass === '10') {
                departments.forEach(dept => {
                    const deptSubjects = subjects[`${selectedClass}-${dept}`] || [];
                    deptSubjects.forEach(subject => {
                        subjectsList.push({ key: `${dept}-${subject}`, label: `${subject} (${dept})` });
                    });
                });
            } else {
                const classSubjects = subjects[selectedClass] || [];
                classSubjects.forEach(subject => {
                    subjectsList.push({ key: subject, label: subject });
                });
            }

            container.innerHTML = subjectsList.map(s => `
                <button onclick="selectSubject('${s.key}')" 
                        data-subject="${s.key}"
                        class="px-4 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                    üìö ${s.label}
                </button>
            `).join('');

            document.getElementById('markEntryTable').classList.add('hidden');
        }

        // Select Subject
        function selectSubject(subject) {
            selectedSubject = subject;
            
            document.querySelectorAll('[data-subject]').forEach(btn => {
                if (btn.getAttribute('data-subject') === subject) {
                    btn.className = 'px-4 py-3 rounded-lg transition bg-green-600 text-white';
                } else {
                    btn.className = 'px-4 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });

            renderMarkTable();
        }

        // Render Mark Entry Table
        function renderMarkTable() {
            const container = document.getElementById('markEntryTable');
            container.classList.remove('hidden');
            
            let filteredStudents = students.filter(s => s.class === selectedClass);
            
            if (selectedSubject.includes('-')) {
                const [dept, subj] = selectedSubject.split('-');
                filteredStudents = filteredStudents.filter(s => s.department === dept);
            }

            const actualSubject = selectedSubject.includes('-') ? selectedSubject.split('-')[1] : selectedSubject;
            
            container.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    üìä Enter Marks for: ${actualSubject}
                    ${selectedSubject.includes('-') ? ` (${selectedSubject.split('-')[0]})` : ''}
                </h3>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="border border-gray-300 p-3">Student Name</th>
                            <th class="border border-gray-300 p-3">Roll</th>
                            <th class="border border-gray-300 p-3">Branch</th>
                            ${selectedSubject.includes('-') ? '<th class="border border-gray-300 p-3">Department</th>' : ''}
                            <th class="border border-gray-300 p-3">Marks (out of 100)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredStudents.map(student => `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-3">${student.name}</td>
                                <td class="border border-gray-300 p-3 text-center">${student.roll}</td>
                                <td class="border border-gray-300 p-3 text-center">${student.branch}</td>
                                ${selectedSubject.includes('-') ? `<td class="border border-gray-300 p-3 text-center">${student.department}</td>` : ''}
                                <td class="border border-gray-300 p-3">
                                    <input type="number" 
                                           min="0" 
                                           max="100" 
                                           value="${student.marks[actualSubject] || 0}"
                                           onchange="updateMark('${student.firestoreId}', '${actualSubject}', this.value, '${student.class}', '${student.branch}', '${student.department}')"
                                           class="w-full border-2 border-gray-300 rounded px-3 py-2 text-center focus:border-blue-500 focus:outline-none">
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Update Mark in Firestore
        async function updateMark(firestoreId, subject, mark, cls, branch, department) {
            const collectionPath = cls >= '9' 
                ? `students/class_${cls}/${department.toLowerCase()}`
                : `students/class_${cls}/branch_${branch}`;

            try {
                await db.collection(collectionPath).doc(firestoreId).update({
                    [`marks.${subject}`]: parseInt(mark) || 0
                });

                // Update local array
                const student = students.find(s => s.firestoreId === firestoreId);
                if (student) {
                    student.marks[subject] = parseInt(mark) || 0;
                }
            } catch (error) {
                console.error('Error updating mark:', error);
                alert('Error updating mark: ' + error.message);
            }
        }

        // Start Application
        window.onload = init;
    </script>
</body>
</html>
