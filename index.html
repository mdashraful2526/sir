<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dumuria Govt. Technical School - Result System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="text-3xl text-blue-600 font-bold mb-4">Loading...</div>
            <div id="loadingStatus" class="text-gray-600">Initializing Firebase...</div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h1 class="text-4xl font-bold text-center text-blue-900 mb-2">
                üéì Dumuria Government Technical School & College
            </h1>
            <p class="text-center text-gray-600">Student Result Management System</p>
        </div>

        <div class="flex justify-end mb-6">
            <button onclick="showLogin()" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                üë§ Admin Login
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üîç Search Student Result</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="searchName" placeholder="Student Name" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                <input type="text" id="searchRoll" placeholder="Roll Number" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                <select id="searchClass" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="">Select Class</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
                <select id="searchBranch" class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                    <option value="">Select Branch</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                </select>
            </div>
            <button onclick="searchStudent()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                üîç Search Result
            </button>

            <div id="searchResult" class="hidden mt-6 p-4 bg-green-50 border-2 border-green-500 rounded-lg">
                <h3 class="text-xl font-bold text-green-800 mb-4">‚úÖ Result Found!</h3>
                <div id="searchResultContent" class="bg-white p-4 rounded-lg"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã All Students</h2>
            <div id="allStudentsList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-3xl font-bold text-center text-blue-900 mb-6">üîê Admin Login</h2>
            <input type="text" id="loginUsername" placeholder="Username" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 mb-4 focus:border-blue-500 focus:outline-none">
            <input type="password" id="loginPassword" placeholder="Password" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 mb-6 focus:border-blue-500 focus:outline-none">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition mb-4">
                Login
            </button>
            <button onclick="showHome()" class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition">
                Back to Home
            </button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPage" class="hidden container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-900">üë®‚Äçüè´ Admin Panel</h1>
            <button onclick="handleLogout()" class="flex items-center gap-2 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
                üö™ Logout
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ûï Add New Student</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="text" id="newStudentName" placeholder="Student Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="number" id="newStudentRoll" placeholder="Roll" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newFatherName" placeholder="Father Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newMotherName" placeholder="Mother Name" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <input type="text" id="newPhone" placeholder="Phone Number" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                <select id="newStudentClass" onchange="checkDepartment()" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                </select>
                <select id="newStudentBranch" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="A">Branch A</option>
                    <option value="B">Branch B</option>
                </select>
                <select id="newStudentDepartment" class="hidden border-2 border-gray-300 rounded-lg px-4 py-2">
                    <option value="">Select Department</option>
                    <option value="Civil">Civil</option>
                    <option value="Computer">Computer</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Mechanical">Mechanical</option>
                </select>
            </div>
            <button id="addStudentBtn" onclick="addStudent()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">
                ‚ûï Add Student
            </button>
        </div>

        <!-- Student List with Delete Option -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleManageStudents()">
                <h2 class="text-2xl font-bold text-gray-800">üë• Manage Students</h2>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    <span id="toggleManageIcon">‚ñº</span> <span id="toggleManageText">Show</span>
                </button>
            </div>
            <div id="manageStudentsContent" class="hidden">
                <div class="mb-4 flex gap-2">
                    <select id="manageClassFilter" onchange="filterStudentsForManage()" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                        <option value="">All Classes</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                    </select>
                    <select id="manageBranchFilter" onchange="filterStudentsForManage()" class="border-2 border-gray-300 rounded-lg px-4 py-2">
                        <option value="">All Branches</option>
                        <option value="A">Branch A</option>
                        <option value="B">Branch B</option>
                    </select>
                </div>
                <div id="manageStudentsList" class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-blue-600 text-white">
                                <th class="border border-gray-300 p-3">Name</th>
                                <th class="border border-gray-300 p-3">Roll</th>
                                <th class="border border-gray-300 p-3">Class</th>
                                <th class="border border-gray-300 p-3">Branch</th>
                                <th class="border border-gray-300 p-3">Department</th>
                                <th class="border border-gray-300 p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="manageStudentsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìù Enter Marks by Subject</h2>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Select Class:</label>
                <div class="flex flex-wrap gap-2">
                    <button onclick="selectClass('6')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="6">Class 6</button>
                    <button onclick="selectClass('7')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="7">Class 7</button>
                    <button onclick="selectClass('8')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="8">Class 8</button>
                    <button onclick="selectClass('9')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="9">Class 9</button>
                    <button onclick="selectClass('10')" class="px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300" data-class="10">Class 10</button>
                </div>
            </div>

            <div id="subjectSelection" class="hidden mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Select Subject:</label>
                <div id="subjectButtons" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>

            <div id="markEntryTable" class="hidden overflow-x-auto"></div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-900">Student Result</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCy9gJJsEfgoT1CLAtaNiaykrrPSTC9q1g",
            authDomain: "sctop-d22bc.firebaseapp.com",
            projectId: "sctop-d22bc",
            storageBucket: "sctop-d22bc.firebasestorage.app",
            messagingSenderId: "733891150436",
            appId: "1:733891150436:web:8ca3a0057030914d8f9571"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global Variables
        let students = [];
        let isAdmin = false;
        let selectedClass = '';
        let selectedSubject = '';

        // Subjects Configuration with detailed mark structure
        const subjects = {
            '6': [
                { name: 'Bangla-1', total: 100, written: 80, mcq: 0, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '7': [
                { name: 'Bangla-1', total: 100, written: 80, mcq: 0, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '8': [
                { name: 'Bangla-1', total: 100, written: 80, mcq: 0, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '9-Civil': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '9-Computer': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '9-Electrical': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '9-Mechanical': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '10-Civil': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '10-Computer': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '10-Electrical': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ],
            '10-Mechanical': [
                { name: 'Bangla-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Bangla-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'English-1', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'English-2', total: 50, written: 30, mcq: 20, practical: 0 },
                { name: 'Math', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Science', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'BGS', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'Voc Engineering', total: 150, written: 80, mcq: 20, practical: 50 },
                { name: 'Religion', total: 100, written: 60, mcq: 40, practical: 0 },
                { name: 'ICT', total: 50, written: 0, mcq: 25, practical: 25 }
            ]
        };

        const departments = ['Civil', 'Computer', 'Electrical', 'Mechanical'];

        // Demo Data
        // Demo Data - Updated structure
        const demoData = [
            { name: "‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶ï‡¶∞‡¶ø‡¶Æ", motherName: "‡¶∏‡¶æ‡¶≤‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01711111111", class: "6", branch: "A", department: "" },
            { name: "‡¶´‡¶æ‡¶§‡¶ø‡¶Æ‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", roll: 2, fatherName: "‡¶Æ‡ßã‡¶π‡¶æ‡¶Æ‡ßç‡¶Æ‡¶¶ ‡¶Ü‡¶≤‡ßÄ", motherName: "‡¶∞‡ßã‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01722222222", class: "6", branch: "A", department: "" },
            { name: "‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 1, fatherName: "‡¶π‡¶æ‡¶∏‡¶æ‡¶® ‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ", motherName: "‡¶Ü‡¶Ø‡¶º‡ßá‡¶∂‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", phone: "01733333333", class: "6", branch: "B", department: "" },
            { name: "‡¶®‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", roll: 2, fatherName: "‡¶Ü‡¶¨‡ßÅ‡¶≤ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∞‡ßÅ‡¶Æ‡¶æ‡¶®‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01744444444", class: "6", branch: "B", department: "" },
            
            { name: "‡¶∏‡¶æ‡¶ï‡¶ø‡¶¨ ‡¶Ü‡¶≤ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", roll: 1, fatherName: "‡¶®‡¶ú‡¶∞‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∂‡¶æ‡¶™‡¶≤‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01755555555", class: "7", branch: "A", department: "" },
            { name: "‡¶§‡¶æ‡¶∏‡¶®‡¶ø‡¶Æ ‡¶ú‡¶æ‡¶π‡¶æ‡¶®", roll: 2, fatherName: "‡¶ú‡¶π‡¶ø‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®", motherName: "‡¶™‡¶æ‡¶∞‡¶≠‡ßÄ‡¶® ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01766666666", class: "7", branch: "A", department: "" },
            
            { name: "‡¶∏‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶´‡¶∞‡¶ø‡¶®", roll: 1, fatherName: "‡¶Æ‡¶§‡¶ø‡¶â‡¶∞ ‡¶∞‡¶π‡¶Æ‡¶æ‡¶®", motherName: "‡¶∏‡ßÅ‡¶Æ‡¶æ‡¶á‡¶Ø‡¶º‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®", phone: "01788888888", class: "8", branch: "A", department: "" },
            
            { name: "‡¶§‡¶æ‡¶®‡¶≠‡ßÄ‡¶∞ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", roll: 1, fatherName: "‡¶ú‡¶π‡¶ø‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®", motherName: "‡¶™‡¶æ‡¶∞‡¶≠‡ßÄ‡¶® ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000001", class: "9", branch: "A", department: "Civil" },
            { name: "‡¶®‡¶æ‡¶¶‡¶ø‡¶Ø‡¶º‡¶æ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", roll: 1, fatherName: "‡¶Ü‡¶¨‡ßÅ‡¶≤ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶Æ", motherName: "‡¶∞‡ßÅ‡¶Æ‡¶æ‡¶®‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞", phone: "01700000003", class: "9", branch: "A", department: "Computer" },
            
            { name: "‡¶∞‡¶æ‡¶ï‡¶ø‡¶¨ ‡¶π‡ßã‡¶∏‡ßá‡¶®", roll: 1, fatherName: "‡¶∂‡¶æ‡¶Æ‡¶∏‡ßÅ‡¶≤ ‡¶π‡¶ï", motherName: "‡¶®‡¶æ‡¶ú‡¶Æ‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ", phone: "01700000007", class: "10", branch: "A", department: "Civil" }
        ];

        // Update Loading Status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = message;
        }

        // Initialize and Load Data from Firestore
        async function init() {
            try {
                updateLoadingStatus('Checking Firebase connection...');
                
                // Check if we need to restructure data
                const needsRestructure = await checkIfNeedsRestructure();
                
                if (needsRestructure) {
                    updateLoadingStatus('Old structure detected. Cleaning up...');
                    await deleteAllOldData();
                    updateLoadingStatus('Creating new professional structure...');
                    await createDemoDataInFirestore();
                } else {
                    updateLoadingStatus('Loading data from Firebase...');
                }
                
                // Load all students
                await loadAllStudents();
                
                updateLoadingStatus('Complete!');
                showHome();
            } catch (error) {
                console.error('Firebase Error:', error);
                updateLoadingStatus('Error: ' + error.message);
                alert('Firebase connection failed. Please check console for details.');
            }
        }

        // Check if database needs restructure
        async function checkIfNeedsRestructure() {
            try {
                // Check if old structure exists (direct students collection)
                const oldStructure = await db.collection('students').get();
                
                // If there are documents directly in students collection (not class_6, class_7, etc.)
                if (!oldStructure.empty) {
                    const firstDoc = oldStructure.docs[0];
                    // Check if it's not our new structure (class_6, class_7, etc.)
                    if (!firstDoc.id.startsWith('class_')) {
                        return true; // Old structure detected
                    }
                }
                
                // Check if new structure exists
                const class6Check = await db.collection('students/class_6/branch_A').limit(1).get();
                if (class6Check.empty) {
                    return true; // No data in new structure, needs creation
                }
                
                return false; // Structure is fine
            } catch (error) {
                console.log('Check error, will create new structure:', error);
                return true;
            }
        }

        // Delete all old data from Firestore
        async function deleteAllOldData() {
            try {
                // Delete old direct students collection
                const oldStudents = await db.collection('students').get();
                const deleteBatch = db.batch();
                let deleteCount = 0;
                
                oldStudents.forEach(doc => {
                    deleteBatch.delete(doc.ref);
                    deleteCount++;
                });
                
                if (deleteCount > 0) {
                    await deleteBatch.commit();
                    updateLoadingStatus(`Deleted ${deleteCount} old records...`);
                }
                
                // Delete all class documents and their subcollections
                for (let cls = 6; cls <= 10; cls++) {
                    const classDocRef = db.collection('students').doc(`class_${cls}`);
                    
                    // Delete subcollections
                    if (cls >= 9) {
                        for (const dept of departments) {
                            await deleteCollection(`students/class_${cls}/${dept.toLowerCase()}`, 10);
                        }
                    } else {
                        await deleteCollection(`students/class_${cls}/branch_A`, 10);
                        await deleteCollection(`students/class_${cls}/branch_B`, 10);
                    }
                    
                    // Delete the class document itself
                    await classDocRef.delete();
                }
                
                updateLoadingStatus('Old data cleaned successfully!');
            } catch (error) {
                console.error('Error deleting old data:', error);
                updateLoadingStatus('Proceeding with new structure...');
            }
        }

        // Helper function to delete collection
        async function deleteCollection(collectionPath, batchSize) {
            const collectionRef = db.collection(collectionPath);
            const query = collectionRef.limit(batchSize);
            
            return new Promise((resolve, reject) => {
                deleteQueryBatch(query, resolve, reject);
            });
        }

        async function deleteQueryBatch(query, resolve, reject) {
            try {
                const snapshot = await query.get();
                
                if (snapshot.size === 0) {
                    resolve();
                    return;
                }
                
                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Recurse on the next process tick
                process.nextTick(() => {
                    deleteQueryBatch(query, resolve, reject);
                });
            } catch (error) {
                reject(error);
            }
        }

        // Create Demo Data in Firestore with NEW STRUCTURE
        async function createDemoDataInFirestore() {
            updateLoadingStatus('Setting up professional database structure...');
            
            // First, create class documents (placeholder)
            for (let cls = 6; cls <= 10; cls++) {
                await db.collection('students').doc(`class_${cls}`).set({
                    className: `Class ${cls}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            let totalCount = 0;
            const totalStudents = demoData.length;

            // Now add students to proper subcollections
            for (const student of demoData) {
                const subjectKey = student.class >= '9' ? `${student.class}-${student.department}` : student.class;
                const marks = {};
                
                // Initialize marks with proper structure
                subjects[subjectKey]?.forEach(subject => {
                    marks[subject.name] = {
                        written: Math.floor(Math.random() * (subject.written * 0.3)) + (subject.written * 0.7),
                        mcq: subject.mcq > 0 ? Math.floor(Math.random() * (subject.mcq * 0.3)) + (subject.mcq * 0.7) : 0,
                        practical: subject.practical > 0 ? Math.floor(Math.random() * (subject.practical * 0.3)) + (subject.practical * 0.7) : 0,
                        total: subject.total
                    };
                });

                const collectionPath = student.class >= '9' 
                    ? `students/class_${student.class}/${student.department.toLowerCase()}`
                    : `students/class_${student.class}/branch_${student.branch}`;

                const docRef = db.collection(collectionPath).doc();
                
                await docRef.set({
                    id: docRef.id,
                    name: student.name,
                    roll: student.roll,
                    fatherName: student.fatherName,
                    motherName: student.motherName,
                    phone: student.phone,
                    class: student.class,
                    branch: student.branch,
                    department: student.department,
                    marks: marks,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                totalCount++;
                updateLoadingStatus(`Creating students... (${totalCount}/${totalStudents}) - ${student.name}`);
            }

            updateLoadingStatus('‚úÖ Professional database structure created successfully!');
        }

        // Load All Students from Firestore
        async function loadAllStudents() {
            students = [];
            updateLoadingStatus('Loading all students from database...');
            
            try {
                for (let cls = 6; cls <= 10; cls++) {
                    if (cls >= 9) {
                        // Load by department for class 9-10
                        for (const dept of departments) {
                            const snapshot = await db.collection(`students/class_${cls}/${dept.toLowerCase()}`).get();
                            snapshot.forEach(doc => {
                                students.push({ ...doc.data(), firestoreId: doc.id });
                            });
                        }
                    } else {
                        // Load by branch for class 6-8
                        for (const branch of ['A', 'B']) {
                            const snapshot = await db.collection(`students/class_${cls}/branch_${branch}`).get();
                            snapshot.forEach(doc => {
                                students.push({ ...doc.data(), firestoreId: doc.id });
                            });
                        }
                    }
                }
                updateLoadingStatus(`Loaded ${students.length} students successfully!`);
            } catch (error) {
                console.error('Error loading students:', error);
                updateLoadingStatus('Error loading students: ' + error.message);
            }
        }

        // Page Navigation
        function showPage(page) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (page === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                renderAllStudents();
            } else if (page === 'login') {
                document.getElementById('loginPage').classList.remove('hidden');
            } else if (page === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
            }
        }

        function showHome() { showPage('home'); }
        function showLogin() { showPage('login'); }
        function showAdmin() { 
            showPage('admin');
            // Reset manage students to closed state when entering admin panel
            manageStudentsVisible = false;
            document.getElementById('manageStudentsContent').classList.add('hidden');
            document.getElementById('toggleManageIcon').textContent = '‚ñº';
            document.getElementById('toggleManageText').textContent = 'Show';
        }

        // Add Student - Check Department
        function checkDepartment() {
            const cls = document.getElementById('newStudentClass').value;
            const deptSelect = document.getElementById('newStudentDepartment');
            
            if (cls === '9' || cls === '10') {
                deptSelect.classList.remove('hidden');
            } else {
                deptSelect.classList.add('hidden');
                deptSelect.value = '';
            }
        }

        // Login
        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === 'admin' && password === 'admin') {
                isAdmin = true;
                showAdmin();
            } else {
                alert('Invalid credentials!');
            }
        }

        function handleLogout() {
            isAdmin = false;
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showHome();
        }

        // Search Student
        function searchStudent() {
            const name = document.getElementById('searchName').value.toLowerCase();
            const roll = document.getElementById('searchRoll').value;
            const cls = document.getElementById('searchClass').value;
            const branch = document.getElementById('searchBranch').value;

            const result = students.find(s => 
                (name && s.name.toLowerCase().includes(name)) ||
                (roll && s.roll.toString() === roll) ||
                (cls && branch && s.class === cls && s.branch === branch)
            );

            const resultDiv = document.getElementById('searchResult');
            const contentDiv = document.getElementById('searchResultContent');

            if (result) {
                resultDiv.classList.remove('hidden');
                contentDiv.innerHTML = `
                    <p><strong>Name:</strong> ${result.name}</p>
                    <p><strong>Roll:</strong> ${result.roll}</p>
                    <p><strong>Class:</strong> ${result.class} | <strong>Branch:</strong> ${result.branch}</p>
                    ${result.department ? `<p><strong>Department:</strong> ${result.department}</p>` : ''}
                    <div class="mt-4">
                        <button onclick='showStudentDetail(${JSON.stringify(result)})' class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mr-2">
                            View Full Result
                        </button>
                        <button onclick='downloadPDF(${JSON.stringify(result)})' class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            üì• Download PDF
                        </button>
                    </div>
                `;
            } else {
                resultDiv.classList.remove('hidden');
                contentDiv.innerHTML = '<p class="text-red-600 font-semibold">‚ùå No student found!</p>';
            }
        }

        // Render All Students
        function renderAllStudents() {
            const container = document.getElementById('allStudentsList');
            container.innerHTML = students.slice(0, 20).map(student => `
                <div onclick='showStudentDetail(${JSON.stringify(student)})' class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-lg cursor-pointer transition">
                    <h3 class="font-bold text-lg text-blue-900">${student.name}</h3>
                    <p class="text-gray-600">Roll: ${student.roll}</p>
                    <p class="text-gray-600">Class: ${student.class} | Branch: ${student.branch}</p>
                    ${student.department ? `<p class="text-gray-600 text-sm">${student.department}</p>` : ''}
                </div>
            `).join('');
        }

        // Show Student Detail Modal
        function showStudentDetail(student) {
            const modal = document.getElementById('studentModal');
            const content = document.getElementById('modalContent');
            
            const total = Object.values(student.marks).reduce((sum, mark) => sum + parseInt(mark || 0), 0);
            
            content.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-lg"><strong>Name:</strong> ${student.name}</p>
                    <p><strong>Father:</strong> ${student.fatherName} | <strong>Mother:</strong> ${student.motherName}</p>
                    <p><strong>Phone:</strong> ${student.phone}</p>
                    <p><strong>Roll:</strong> ${student.roll} | <strong>Class:</strong> ${student.class} | <strong>Branch:</strong> ${student.branch}</p>
                    ${student.department ? `<p><strong>Department:</strong> ${student.department}</p>` : ''}
                </div>

                <table class="w-full border-collapse mb-4">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="border border-gray-300 p-3">Subject</th>
                            <th class="border border-gray-300 p-3">Marks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(student.marks).map(([subject, mark]) => `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-3">${subject}</td>
                                <td class="border border-gray-300 p-3 text-center font-semibold">${mark}</td>
                            </tr>
                        `).join('')}
                        <tr class="bg-green-100 font-bold">
                            <td class="border border-gray-300 p-3">TOTAL</td>
                            <td class="border border-gray-300 p-3 text-center">${total}</td>
                        </tr>
                    </tbody>
                </table>

                <button onclick='downloadPDF(${JSON.stringify(student)})' class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                    üì• Download Result PDF
                </button>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('studentModal').classList.add('hidden');
        }

        // Download PDF
        function downloadPDF(student) {
            const subjectKey = student.class >= '9' ? `${student.class}-${student.department}` : student.class;
            const studentSubjects = subjects[subjectKey] || [];
            const total = Object.values(student.marks).reduce((sum, mark) => sum + parseInt(mark || 0), 0);
            
            const pdfHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4 landscape; margin: 20mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { color: #1e40af; margin: 5px 0; font-size: 28px; }
        .header h2 { color: #4b5563; margin: 5px 0; font-size: 18px; }
        .info { display: flex; justify-content: space-between; margin: 20px 0; padding: 15px; background: #f3f4f6; border-radius: 8px; }
        .info-item { margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 2px solid #2563eb; padding: 12px; text-align: center; }
        th { background: #2563eb; color: white; font-size: 16px; }
        tr:nth-child(even) { background: #eff6ff; }
        .total { font-weight: bold; background: #dbeafe !important; font-size: 18px; }
        .footer { margin-top: 30px; text-align: center; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Dumuria Government Technical School & College</h1>
        <h2>Academic Result Sheet</h2>
    </div>
    
    <div class="info">
        <div>
            <div class="info-item"><strong>Student Name:</strong> ${student.name}</div>
            <div class="info-item"><strong>Father Name:</strong> ${student.fatherName}</div>
            <div class="info-item"><strong>Mother Name:</strong> ${student.motherName}</div>
        </div>
        <div>
            <div class="info-item"><strong>Roll Number:</strong> ${student.roll}</div>
            <div class="info-item"><strong>Class:</strong> ${student.class} | <strong>Branch:</strong> ${student.branch}</div>
            ${student.department ? `<div class="info-item"><strong>Department:</strong> ${student.department}</div>` : ''}
            <div class="info-item"><strong>Phone:</strong> ${student.phone}</div>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Subject</th>
                <th>Marks Obtained</th>
                <th>Total Marks</th>
            </tr>
        </thead>
        <tbody>
            ${studentSubjects.map(subject => `
                <tr>
                    <td>${subject}</td>
                    <td>${student.marks[subject] || 0}</td>
                    <td>100</td>
                </tr>
            `).join('')}
            <tr class="total">
                <td>TOTAL</td>
                <td>${total}</td>
                <td>${studentSubjects.length * 100}</td>
            </tr>
        </tbody>
    </table>
    
    <div class="footer">
        <p>Generated on ${new Date().toLocaleDateString()}</p>
        <p>This is a computer-generated document</p>
    </div>
</body>
</html>`;

            const blob = new Blob([pdfHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Result_${student.name}_Class${student.class}${student.branch}.html`;
            a.click();
        }

        // Global variable to prevent duplicate submissions
        let isSubmitting = false;
        let manageStudentsVisible = false;

        // Toggle Manage Students Section
        function toggleManageStudents() {
            const content = document.getElementById('manageStudentsContent');
            const icon = document.getElementById('toggleManageIcon');
            const text = document.getElementById('toggleManageText');
            
            manageStudentsVisible = !manageStudentsVisible;
            
            if (manageStudentsVisible) {
                content.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
                text.textContent = 'Hide';
                filterStudentsForManage(); // Load data when opening
            } else {
                content.classList.add('hidden');
                icon.textContent = '‚ñº';
                text.textContent = 'Show';
            }
        }

        // Add Student with duplicate prevention
        async function addStudent() {
            // Prevent duplicate submissions
            if (isSubmitting) {
                alert('Please wait, student is being added...');
                return;
            }

            const name = document.getElementById('newStudentName').value.trim();
            const roll = document.getElementById('newStudentRoll').value.trim();
            const fatherName = document.getElementById('newFatherName').value.trim();
            const motherName = document.getElementById('newMotherName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const cls = document.getElementById('newStudentClass').value;
            const branch = document.getElementById('newStudentBranch').value;
            const department = document.getElementById('newStudentDepartment').value;

            if (!name || !roll || !fatherName || !motherName || !phone) {
                alert('Please fill all required fields!');
                return;
            }

            if ((cls === '9' || cls === '10') && !department) {
                alert('Please select department for Class 9/10!');
                return;
            }

            // Check if student already exists (same name, roll, class, branch)
            const existingStudent = students.find(s => 
                s.name.toLowerCase() === name.toLowerCase() && 
                s.roll === parseInt(roll) && 
                s.class === cls && 
                s.branch === branch
            );

            if (existingStudent) {
                alert('A student with the same name, roll, class, and branch already exists!');
                return;
            }

            // Disable button and show loading state
            isSubmitting = true;
            const addBtn = document.getElementById('addStudentBtn');
            addBtn.disabled = true;
            addBtn.innerHTML = '‚è≥ Adding Student...';
            addBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const subjectKey = cls >= '9' ? `${cls}-${department}` : cls;
            const marks = {};
            subjects[subjectKey]?.forEach(subject => {
                marks[subject.name] = {
                    written: 0,
                    mcq: 0,
                    practical: 0,
                    total: subject.total
                };
            });

            const collectionPath = cls >= '9' 
                ? `students/class_${cls}/${department.toLowerCase()}`
                : `students/class_${cls}/branch_${branch}`;

            try {
                const docRef = await db.collection(collectionPath).add({
                    name: name,
                    roll: parseInt(roll),
                    fatherName: fatherName,
                    motherName: motherName,
                    phone: phone,
                    class: cls,
                    branch: branch,
                    department: department,
                    marks: marks,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Reload students
                await loadAllStudents();

                // Clear form
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentRoll').value = '';
                document.getElementById('newFatherName').value = '';
                document.getElementById('newMotherName').value = '';
                document.getElementById('newPhone').value = '';
                
                // Refresh manage students list
                filterStudentsForManage();
                
                alert('‚úÖ Student added successfully!');
            } catch (error) {
                console.error('Error adding student:', error);
                alert('‚ùå Error adding student: ' + error.message);
            } finally {
                // Re-enable button
                isSubmitting = false;
                addBtn.disabled = false;
                addBtn.innerHTML = '‚ûï Add Student';
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Filter and display students for management
        function filterStudentsForManage() {
            const classFilter = document.getElementById('manageClassFilter').value;
            const branchFilter = document.getElementById('manageBranchFilter').value;
            
            let filtered = students;
            
            if (classFilter) {
                filtered = filtered.filter(s => s.class === classFilter);
            }
            
            if (branchFilter) {
                filtered = filtered.filter(s => s.branch === branchFilter);
            }

            const tbody = document.getElementById('manageStudentsBody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 p-3">${student.name}</td>
                    <td class="border border-gray-300 p-3 text-center">${student.roll}</td>
                    <td class="border border-gray-300 p-3 text-center">${student.class}</td>
                    <td class="border border-gray-300 p-3 text-center">${student.branch}</td>
                    <td class="border border-gray-300 p-3 text-center">${student.department || '-'}</td>
                    <td class="border border-gray-300 p-3 text-center">
                        <button onclick='deleteStudent("${student.firestoreId}", "${student.class}", "${student.branch}", "${student.department}", "${student.name}")' 
                                class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete Student
        async function deleteStudent(firestoreId, cls, branch, department, name) {
            if (!confirm(`Are you sure you want to delete ${name}?`)) {
                return;
            }

            const collectionPath = cls >= '9' 
                ? `students/class_${cls}/${department.toLowerCase()}`
                : `students/class_${cls}/branch_${branch}`;

            try {
                await db.collection(collectionPath).doc(firestoreId).delete();
                
                // Remove from local array
                students = students.filter(s => s.firestoreId !== firestoreId);
                
                // Refresh the list
                filterStudentsForManage();
                
                alert('‚úÖ Student deleted successfully!');
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('‚ùå Error deleting student: ' + error.message);
            }
        }

        // Select Class for Mark Entry
        function selectClass(cls) {
            selectedClass = cls;
            selectedSubject = '';
            
            document.querySelectorAll('[data-class]').forEach(btn => {
                if (btn.getAttribute('data-class') === cls) {
                    btn.className = 'px-6 py-3 rounded-lg transition bg-blue-600 text-white';
                } else {
                    btn.className = 'px-6 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });

            renderSubjects();
        }

        // Render Subjects
        function renderSubjects() {
            const container = document.getElementById('subjectButtons');
            const section = document.getElementById('subjectSelection');
            section.classList.remove('hidden');
            
            let subjectsList = [];
            
            if (selectedClass === '9' || selectedClass === '10') {
                departments.forEach(dept => {
                    const deptSubjects = subjects[`${selectedClass}-${dept}`] || [];
                    deptSubjects.forEach(subject => {
                        subjectsList.push({ key: `${dept}-${subject.name}`, label: `${subject.name} (${dept})`, subject: subject });
                    });
                });
            } else {
                const classSubjects = subjects[selectedClass] || [];
                classSubjects.forEach(subject => {
                    subjectsList.push({ key: subject.name, label: subject.name, subject: subject });
                });
            }

            container.innerHTML = subjectsList.map(s => `
                <button onclick='selectSubject(${JSON.stringify(s.key)}, ${JSON.stringify(s.subject)})' 
                        data-subject="${s.key}"
                        class="px-4 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                    üìö ${s.label}
                </button>
            `).join('');

            document.getElementById('markEntryTable').classList.add('hidden');
        }

        // Select Subject
        let currentSubjectData = null;
        function selectSubject(subject, subjectData) {
            selectedSubject = subject;
            currentSubjectData = subjectData;
            
            document.querySelectorAll('[data-subject]').forEach(btn => {
                if (btn.getAttribute('data-subject') === subject) {
                    btn.className = 'px-4 py-3 rounded-lg transition bg-green-600 text-white';
                } else {
                    btn.className = 'px-4 py-3 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });

            renderMarkTable();
        }

        // Render Mark Entry Table with Written, MCQ, Practical columns
        function renderMarkTable() {
            const container = document.getElementById('markEntryTable');
            container.classList.remove('hidden');
            
            let filteredStudents = students.filter(s => s.class === selectedClass);
            
            if (selectedSubject.includes('-')) {
                const [dept, subj] = selectedSubject.split('-', 1);
                filteredStudents = filteredStudents.filter(s => s.department === dept);
            }

            const actualSubject = selectedSubject.includes('-') ? selectedSubject.split('-').slice(1).join('-') : selectedSubject;
            
            // Build table headers based on subject type
            let headers = '<th class="border border-gray-300 p-3">Student Name</th><th class="border border-gray-300 p-3">Roll</th><th class="border border-gray-300 p-3">Branch</th>';
            
            if (selectedSubject.includes('-')) {
                headers += '<th class="border border-gray-300 p-3">Department</th>';
            }
            
            if (currentSubjectData.written > 0) {
                headers += `<th class="border border-gray-300 p-3">Written (${currentSubjectData.written})</th>`;
            }
            if (currentSubjectData.mcq > 0) {
                headers += `<th class="border border-gray-300 p-3">MCQ (${currentSubjectData.mcq})</th>`;
            }
            if (currentSubjectData.practical > 0) {
                headers += `<th class="border border-gray-300 p-3">Practical (${currentSubjectData.practical})</th>`;
            }
            headers += `<th class="border border-gray-300 p-3">Total (${currentSubjectData.total})</th>`;
            
            container.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    üìä Enter Marks for: ${actualSubject}
                    ${selectedSubject.includes('-') ? ` (${selectedSubject.split('-')[0]})` : ''}
                </h3>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            ${headers}
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredStudents.map(student => {
                            const studentMarks = student.marks[actualSubject] || { written: 0, mcq: 0, practical: 0 };
                            const total = (parseInt(studentMarks.written) || 0) + (parseInt(studentMarks.mcq) || 0) + (parseInt(studentMarks.practical) || 0);
                            
                            let cells = `
                                <td class="border border-gray-300 p-3">${student.name}</td>
                                <td class="border border-gray-300 p-3 text-center">${student.roll}</td>
                                <td class="border border-gray-300 p-3 text-center">${student.branch}</td>
                            `;
                            
                            if (selectedSubject.includes('-')) {
                                cells += `<td class="border border-gray-300 p-3 text-center">${student.department}</td>`;
                            }
                            
                            if (currentSubjectData.written > 0) {
                                cells += `
                                    <td class="border border-gray-300 p-3">
                                        <input type="number" 
                                               min="0" 
                                               max="${currentSubjectData.written}" 
                                               value="${studentMarks.written || 0}"
                                               onchange="updateMarkField('${student.firestoreId}', '${actualSubject}', 'written', this.value, '${student.class}', '${student.branch}', '${student.department}')"
                                               class="w-full border-2 border-gray-300 rounded px-3 py-2 text-center focus:border-blue-500 focus:outline-none">
                                    </td>
                                `;
                            }
                            
                            if (currentSubjectData.mcq > 0) {
                                cells += `
                                    <td class="border border-gray-300 p-3">
                                        <input type="number" 
                                               min="0" 
                                               max="${currentSubjectData.mcq}" 
                                               value="${studentMarks.mcq || 0}"
                                               onchange="updateMarkField('${student.firestoreId}', '${actualSubject}', 'mcq', this.value, '${student.class}', '${student.branch}', '${student.department}')"
                                               class="w-full border-2 border-gray-300 rounded px-3 py-2 text-center focus:border-blue-500 focus:outline-none">
                                    </td>
                                `;
                            }
                            
                            if (currentSubjectData.practical > 0) {
                                cells += `
                                    <td class="border border-gray-300 p-3">
                                        <input type="number" 
                                               min="0" 
                                               max="${currentSubjectData.practical}" 
                                               value="${studentMarks.practical || 0}"
                                               onchange="updateMarkField('${student.firestoreId}', '${actualSubject}', 'practical', this.value, '${student.class}', '${student.branch}', '${student.department}')"
                                               class="w-full border-2 border-gray-300 rounded px-3 py-2 text-center focus:border-blue-500 focus:outline-none">
                                    </td>
                                `;
                            }
                            
                            cells += `<td class="border border-gray-300 p-3 text-center font-bold bg-gray-100">${total}</td>`;
                            
                            return `<tr class="hover:bg-gray-50">${cells}</tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Update Mark Field in Firestore
        async function updateMarkField(firestoreId, subject, field, value, cls, branch, department) {
            const collectionPath = cls >= '9' 
                ? `students/class_${cls}/${department.toLowerCase()}`
                : `students/class_${cls}/branch_${branch}`;

            try {
                await db.collection(collectionPath).doc(firestoreId).update({
                    [`marks.${subject}.${field}`]: parseInt(value) || 0
                });

                // Update local array
                const student = students.find(s => s.firestoreId === firestoreId);
                if (student && student.marks[subject]) {
                    student.marks[subject][field] = parseInt(value) || 0;
                }
                
                // Re-render table to update total
                renderMarkTable();
            } catch (error) {
                console.error('Error updating mark:', error);
                alert('Error updating mark: ' + error.message);
            }
        }

        // Start Application
        window.onload = init;
    </script>
</body>
</html>
